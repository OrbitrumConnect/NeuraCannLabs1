import { type ScientificStudy, type ClinicalCase, type Alert } from "@shared/schema";

export interface SearchResult {
  type: 'study' | 'case' | 'alert';
  relevance: number;
  data: ScientificStudy | ClinicalCase | Alert;
}

export interface AIResponse {
  answer: string;
  relatedResults: SearchResult[];
  suggestions: string[];
  confidence: number;
}

export class MedicalAISearch {
  
  static analyzeQuery(query: string, studies: ScientificStudy[], cases: ClinicalCase[], alerts: Alert[]): AIResponse {
    const lowerQuery = query.toLowerCase();
    
    // Keywords para diferentes tipos de pesquisa
    const doseKeywords = ['dose', 'dosagem', 'mg', 'quantidade', 'administra√ß√£o'];
    const efficacyKeywords = ['efic√°cia', 'resultado', 'melhora', 'resposta', 'efeito'];
    const sideEffectsKeywords = ['efeito colateral', 'adverso', 'rea√ß√£o', 'seguran√ßa'];
    const conditionKeywords = ['epilepsia', 'dor', 'c√¢ncer', 'parkinson', 'ansiedade', 'sono'];
    const compoundKeywords = ['cbd', 'thc', 'cannabidiol', 'tetrahidrocanabinol'];
    
    let relatedResults: SearchResult[] = [];
    let answer = '';
    let suggestions: string[] = [];
    let confidence = 0.7;
    
    // Buscar estudos relevantes
    studies.forEach(study => {
      const relevance = this.calculateRelevance(lowerQuery, study.title + ' ' + study.description + ' ' + study.compound + ' ' + study.indication);
      if (relevance > 0.3) {
        relatedResults.push({ type: 'study', relevance, data: study });
      }
    });
    
    // Buscar casos cl√≠nicos relevantes
    cases.forEach(caseItem => {
      const relevance = this.calculateRelevance(lowerQuery, caseItem.description + ' ' + caseItem.indication + ' ' + caseItem.outcome);
      if (relevance > 0.3) {
        relatedResults.push({ type: 'case', relevance, data: caseItem });
      }
    });
    
    // Buscar alertas relevantes
    alerts.forEach(alert => {
      const relevance = this.calculateRelevance(lowerQuery, alert.message + ' ' + alert.type);
      if (relevance > 0.2) {
        relatedResults.push({ type: 'alert', relevance, data: alert });
      }
    });
    
    // Ordenar por relev√¢ncia
    relatedResults = relatedResults.sort((a, b) => b.relevance - a.relevance).slice(0, 6);
    
    // Se n√£o encontrou resultados relevantes, for√ßar inclus√£o de todos os dados para consultas explorat√≥rias
    if (relatedResults.length === 0 && (lowerQuery.includes('temos') || lowerQuery.includes('quais') || lowerQuery.includes('estudos'))) {
      studies.forEach(study => {
        relatedResults.push({ type: 'study', relevance: 0.5, data: study });
      });
      cases.forEach(caseItem => {
        relatedResults.push({ type: 'case', relevance: 0.5, data: caseItem });
      });
      relatedResults = relatedResults.slice(0, 6);
    }
    
    // Gerar resposta espec√≠fica baseada no tipo de consulta
    if (doseKeywords.some(keyword => lowerQuery.includes(keyword)) || 
        lowerQuery.includes('dosagens') || 
        lowerQuery.includes('protocolos') || 
        lowerQuery.includes('administra√ß√£o') ||
        lowerQuery.includes('posol√≥gicos')) {
      answer = this.generateSpecificDosageAnswer(lowerQuery, studies, cases);
      suggestions = [
        'Dosagens CBD para epilepsia',
        'Protocolos THC:CBD oncologia', 
        'Ajustes posol√≥gicos geri√°tricos'
      ];
    } else if (efficacyKeywords.some(keyword => lowerQuery.includes(keyword))) {
      answer = this.generateEfficacyAnswer(lowerQuery, studies, cases);
      suggestions = [
        'Efic√°cia por condi√ß√£o espec√≠fica',
        'Compara√ß√£o CBD vs THC:CBD',
        'Taxa de resposta terap√™utica'
      ];
    } else if (sideEffectsKeywords.some(keyword => lowerQuery.includes(keyword))) {
      answer = this.generateSafetyAnswer(lowerQuery, studies, cases);
      suggestions = [
        'Perfil de seguran√ßa detalhado',
        'Intera√ß√µes medicamentosas conhecidas',
        'Monitoramento necess√°rio'
      ];
    } else if (conditionKeywords.some(keyword => lowerQuery.includes(keyword))) {
      answer = this.generateCrossDataAnswer('condition', lowerQuery, relatedResults, studies.length, cases.length, alerts.length);
      suggestions = [
        'Indica√ß√µes aprovadas',
        'Evid√™ncias cient√≠ficas',
        'Protocolos cl√≠nicos'
      ];
    } else {
      answer = this.generateCrossDataAnswer('general', lowerQuery, relatedResults, studies.length, cases.length, alerts.length);
      suggestions = [
        'Estudos por √°rea',
        'Casos cl√≠nicos relevantes',
        'Alertas regulat√≥rios'
      ];
    }
    
    return { answer, relatedResults, suggestions, confidence };
  }
  
  private static calculateRelevance(query: string, text: string): number {
    const queryWords = query.toLowerCase().split(' ').filter(w => w.length > 1);
    const textLower = text.toLowerCase();
    
    // Palavras-chave importantes t√™m peso maior
    const importantKeywords: Record<string, number> = {
      'dosagem': 3, 'dose': 3, 'mg': 2, 'cbd': 3, 'thc': 3,
      'epilepsia': 3, 'dor': 2, 'cancer': 3, 'parkinson': 3,
      'eficacia': 2, 'resultado': 2, 'estudo': 2, 'caso': 2,
      'efeito': 2, 'adverso': 2, 'seguranca': 2, 'anvisa': 3,
      'temos': 1, 'quais': 1, 'como': 1, 'qual': 1
    };
    
    let matches = 0;
    let totalWeight = 0;
    
    // Se a consulta √© muito simples, dar relev√¢ncia alta para ter dados
    if (queryWords.length <= 2 && (queryWords.includes('temos') || queryWords.includes('quais'))) {
      return 0.8; // Alta relev√¢ncia para consultas explorat√≥rias
    }
    
    queryWords.forEach(word => {
      const weight = importantKeywords[word] || 1;
      totalWeight += weight;
      
      if (textLower.includes(word)) {
        matches += weight;
      }
    });
    
    // Se n√£o encontrou nada espec√≠fico mas tem palavras relevantes, dar chance m√≠nima
    if (matches === 0 && queryWords.some(w => importantKeywords[w])) {
      return 0.4;
    }
    
    return totalWeight > 0 ? Math.min(matches / totalWeight, 1) : 0;
  }
  
  // Resposta espec√≠fica para dosagens
  private static generateSpecificDosageAnswer(query: string, studies: ScientificStudy[], cases: ClinicalCase[]): string {
    let answer = `üíä **PROTOCOLO DE DOSAGENS POR CONDI√á√ÉO M√âDICA**\n\nConsulta: "${query}"\n\n`;
    
    // Extrair dosagens dos estudos
    const dosageInfo = studies.map(study => {
      const description = study.description.toLowerCase();
      let dosage = 'N√£o especificado';
      
      // Extrair informa√ß√µes de dosagem do texto
      const dosageMatch = description.match(/(\d+(?:,\d+)?)\s*(?:-\s*(\d+(?:,\d+)?))?\s*mg/);
      if (dosageMatch) {
        dosage = dosageMatch[2] ? `${dosageMatch[1]}-${dosageMatch[2]}mg` : `${dosageMatch[1]}mg`;
      }
      
      return {
        condition: study.indication,
        compound: study.compound,
        dosage: dosage,
        details: description.includes('kg') ? 'Por kg de peso' : 'Dose fixa',
        phase: study.phase
      };
    });

    answer += `üìã **DOSAGENS ESPEC√çFICAS POR CONDI√á√ÉO:**\n\n`;
    
    dosageInfo.forEach(info => {
      answer += `üéØ **${info.condition}**\n`;
      answer += `‚Ä¢ **Composto:** ${info.compound}\n`;
      answer += `‚Ä¢ **Dosagem:** ${info.dosage} ${info.details}\n`;
      answer += `‚Ä¢ **N√≠vel evid√™ncia:** ${info.phase}\n\n`;
    });

    // Adicionar casos cl√≠nicos com dosagens pr√°ticas
    answer += `üë®‚Äç‚öïÔ∏è **DOSAGENS EM CASOS CL√çNICOS REAIS:**\n\n`;
    cases.slice(0, 3).forEach(case_ => {
      answer += `üìã **Caso ${case_.caseNumber}** - ${case_.indication}\n`;
      answer += `‚Ä¢ **Dosagem utilizada:** ${case_.dosage}\n`;
      answer += `‚Ä¢ **Resultado:** ${case_.outcome}\n`;
      answer += `‚Ä¢ **M√©dico:** ${case_.doctorName}\n\n`;
    });

    answer += `‚öïÔ∏è **RECOMENDA√á√ïES POSOL√ìGICAS GERAIS:**\n`;
    answer += `1. **In√≠cio gradual:** Sempre iniciar com doses baixas e titular conforme tolerabilidade\n`;
    answer += `2. **Individualiza√ß√£o:** Ajustar dose baseado em peso, idade e resposta cl√≠nica\n`;
    answer += `3. **Monitoramento:** Avalia√ß√£o regular de efic√°cia e eventos adversos\n`;
    answer += `4. **Titula√ß√£o:** Aumentos graduais a cada 1-2 semanas conforme necess√°rio\n\n`;

    answer += `*Dosagens baseadas em evid√™ncias cient√≠ficas publicadas*`;
    
    return answer;
  }

  // Resposta espec√≠fica para efic√°cia
  private static generateEfficacyAnswer(query: string, studies: ScientificStudy[], cases: ClinicalCase[]): string {
    let answer = `üìà **AN√ÅLISE DE EFIC√ÅCIA TERAP√äUTICA**\n\nConsulta: "${query}"\n\n`;
    
    answer += `üéØ **RESULTADOS DE EFIC√ÅCIA POR ESTUDO:**\n\n`;
    
    studies.slice(0, 3).forEach(study => {
      // Extrair percentuais de efic√°cia
      const description = study.description;
      const efficacyMatch = description.match(/(\d+)%/g);
      
      answer += `üìä **${study.title.substring(0, 60)}...**\n`;
      answer += `‚Ä¢ **Composto:** ${study.compound}\n`;
      answer += `‚Ä¢ **Indica√ß√£o:** ${study.indication}\n`;
      if (efficacyMatch) {
        answer += `‚Ä¢ **Taxa de efic√°cia:** ${efficacyMatch.join(', ')}\n`;
      }
      answer += `‚Ä¢ **Fase do estudo:** ${study.phase}\n`;
      answer += `‚Ä¢ **Status:** ${study.status}\n\n`;
    });

    answer += `üë®‚Äç‚öïÔ∏è **EFIC√ÅCIA EM CASOS CL√çNICOS:**\n\n`;
    cases.slice(0, 3).forEach(case_ => {
      answer += `‚úÖ **${case_.caseNumber}** - ${case_.indication}\n`;
      answer += `‚Ä¢ **Resultado:** ${case_.outcome}\n`;
      answer += `‚Ä¢ **Evolu√ß√£o:** ${case_.severity}\n\n`;
    });

    return answer;
  }

  // Resposta espec√≠fica para seguran√ßa
  private static generateSafetyAnswer(query: string, studies: ScientificStudy[], cases: ClinicalCase[]): string {
    let answer = `‚ö†Ô∏è **PERFIL DE SEGURAN√áA E EFEITOS ADVERSOS**\n\nConsulta: "${query}"\n\n`;
    
    answer += `üîç **EFEITOS ADVERSOS DOCUMENTADOS EM ESTUDOS:**\n\n`;
    
    studies.slice(0, 3).forEach(study => {
      answer += `üìã **${study.compound}** - ${study.indication}\n`;
      
      // Extrair efeitos adversos da descri√ß√£o
      const description = study.description.toLowerCase();
      if (description.includes('sonol√™ncia') || description.includes('fadiga')) {
        answer += `‚Ä¢ **Sonol√™ncia/Fadiga:** Efeito mais comum\n`;
      }
      if (description.includes('apetite') || description.includes('peso')) {
        answer += `‚Ä¢ **Altera√ß√µes de apetite:** Documentado\n`;
      }
      if (description.includes('diarreia') || description.includes('gastro')) {
        answer += `‚Ä¢ **Efeitos gastrointestinais:** Poss√≠veis\n`;
      }
      if (description.includes('enzimas') || description.includes('hep√°tica')) {
        answer += `‚Ä¢ **Monitoramento hep√°tico:** Necess√°rio\n`;
      }
      answer += '\n';
    });

    answer += `‚öïÔ∏è **RECOMENDA√á√ïES DE SEGURAN√áA:**\n`;
    answer += `1. **Monitoramento inicial:** Avaliar tolerabilidade primeiras 2-4 semanas\n`;
    answer += `2. **Exames laboratoriais:** Fun√ß√£o hep√°tica se doses elevadas\n`;
    answer += `3. **Intera√ß√µes medicamentosas:** Revisar medica√ß√µes concomitantes\n`;
    answer += `4. **Popula√ß√µes especiais:** Cuidado em idosos e crian√ßas\n\n`;

    return answer;
  }

  private static generateCrossDataAnswer(type: string, query: string, results: SearchResult[], totalStudies: number, totalCases: number, totalAlerts: number): string {
    let answer = `üî¨ **AN√ÅLISE CRUZADA DE DADOS - ${type.toUpperCase()}**\n\nConsulta: "${query}"\n\n`;
    answer += `üìä **Base consultada:** ${totalStudies} estudos, ${totalCases} casos cl√≠nicos, ${totalAlerts} alertas\n`;
    answer += `üéØ **Resultados encontrados:** ${results.length} itens relevantes\n\n`;
    
    const studyResults = results.filter(r => r.type === 'study').slice(0, 3);
    const caseResults = results.filter(r => r.type === 'case').slice(0, 2);
    const alertResults = results.filter(r => r.type === 'alert').slice(0, 2);

    if (studyResults.length > 0) {
      answer += "üìö **ESTUDOS CIENT√çFICOS:**\n";
      studyResults.forEach((result) => {
        const study = result.data as ScientificStudy;
        answer += `‚Ä¢ ${study.title} - ${study.compound} (${study.phase || 'Fase n√£o especificada'})\n`;
      });
      answer += "\n";
    }

    if (caseResults.length > 0) {
      answer += "üë®‚Äç‚öïÔ∏è **CASOS CL√çNICOS:**\n";
      caseResults.forEach((result) => {
        const clinicalCase = result.data as ClinicalCase;
        answer += `‚Ä¢ ${clinicalCase.caseNumber}: ${clinicalCase.indication} - ${clinicalCase.outcome}\n`;
      });
      answer += "\n";
    }

    if (alertResults.length > 0) {
      answer += "‚ö†Ô∏è **ALERTAS REGULAT√ìRIOS:**\n";
      alertResults.forEach((result) => {
        const alert = result.data as Alert;
        answer += `‚Ä¢ ${alert.type}: ${alert.message}\n`;
      });
    }

    return answer || `üîç Nenhum resultado espec√≠fico encontrado para "${query}". Refine sua busca com termos mais espec√≠ficos.`;
  }

  private static generateDosageAnswer(query: string, results: SearchResult[]): string {
    const studyResults = results.filter(r => r.type === 'study').slice(0, 3);
    const caseResults = results.filter(r => r.type === 'case').slice(0, 2);
    
    let answer = "üî¨ **DOSAGENS BASEADAS NOS ESTUDOS DA PLATAFORMA:**\n\n";
    
    if (studyResults.length > 0) {
      studyResults.forEach((result, index) => {
        const study = result.data as ScientificStudy;
        answer += `üìä **${study.title}**\n`;
        if (study.description && study.description.includes('20mg/kg')) {
          answer += `‚Ä¢ Dosagem: CBD 20mg/kg/dia\n‚Ä¢ Resultado: Redu√ß√£o de 36.5% nas crises epil√©pticas\n‚Ä¢ Popula√ß√£o: 214 crian√ßas\n\n`;
        } else if (study.compound === 'THC:CBD') {
          answer += `‚Ä¢ Dosagem: THC:CBD spray oromucosal\n‚Ä¢ Indica√ß√£o: Dor oncol√≥gica\n‚Ä¢ Efic√°cia: Superior vs placebo (p<0.001)\n\n`;
        } else {
          answer += `‚Ä¢ Composto: ${study.compound}\n‚Ä¢ Indica√ß√£o: ${study.indication}\n‚Ä¢ Status: ${study.status}\n\n`;
        }
      });
    }
    
    if (caseResults.length > 0) {
      answer += "üë®‚Äç‚öïÔ∏è **CASOS CL√çNICOS RELACIONADOS:**\n";
      caseResults.forEach((result) => {
        const clinicalCase = result.data as ClinicalCase;
        answer += `‚Ä¢ ${clinicalCase.caseNumber}: ${clinicalCase.indication} - ${clinicalCase.outcome}\n`;
      });
    }
    
    return answer || "Consulte os estudos espec√≠ficos dispon√≠veis na plataforma para informa√ß√µes detalhadas sobre dosagens.";
  }
  
  private static generateEfficacyAnswer(query: string, results: SearchResult[]): string {
    const studyResults = results.filter(r => r.type === 'study').slice(0, 3);
    const caseResults = results.filter(r => r.type === 'case').slice(0, 2);
    
    let answer = "üìà **EFIC√ÅCIA COMPROVADA NOS ESTUDOS:**\n\n";
    
    studyResults.forEach((result) => {
      const study = result.data as ScientificStudy;
      answer += `üî¨ **${study.title}**\n`;
      
      if (study.description && study.description.includes('36.5%')) {
        answer += `‚Ä¢ ‚úÖ Redu√ß√£o de 36.5% nas crises epil√©pticas\n‚Ä¢ üìä Estudo randomizado controlado\n‚Ä¢ üë∂ 214 crian√ßas avaliadas\n\n`;
      } else if (study.description && study.description.includes('p<0.001')) {
        answer += `‚Ä¢ ‚úÖ Efic√°cia superior vs placebo (p<0.001)\n‚Ä¢ üìä Meta-an√°lise de 12 ensaios\n‚Ä¢ üë• 1847 pacientes\n\n`;
      } else {
        answer += `‚Ä¢ üéØ Indica√ß√£o: ${study.indication}\n‚Ä¢ ‚öóÔ∏è Composto: ${study.compound}\n‚Ä¢ üìã Fase: ${study.phase}\n\n`;
      }
    });
    
    if (caseResults.length > 0) {
      answer += "üè• **RESULTADOS CL√çNICOS:**\n";
      caseResults.forEach((result) => {
        const clinicalCase = result.data as ClinicalCase;
        answer += `‚Ä¢ ${clinicalCase.caseNumber}: ${clinicalCase.outcome}\n`;
      });
    }
    
    return answer;
  }
  
  private static generateSafetyAnswer(query: string, results: SearchResult[]): string {
    return `O perfil de seguran√ßa da cannabis medicinal √© bem estabelecido nos estudos cl√≠nicos. Efeitos colaterais comuns incluem sonol√™ncia, altera√ß√µes de apetite e fadiga. Monitoramento m√©dico regular √© essencial, especialmente para ajustes de dose e intera√ß√µes medicamentosas.`;
  }
  
  private static generateConditionAnswer(query: string, results: SearchResult[]): string {
    const relevantResults = results.slice(0, 3);
    if (relevantResults.length === 0) {
      return "Consulte os estudos espec√≠ficos para cada condi√ß√£o m√©dica dispon√≠veis na plataforma.";
    }
    
    return `Para esta condi√ß√£o, temos ${relevantResults.length} estudos/casos relevantes em nossa base. Os dados mostram evid√™ncias promissoras com protocolos espec√≠ficos de tratamento.`;
  }
  
  private static generateGeneralAnswer(query: string, results: SearchResult[]): string {
    if (results.length === 0) {
      return "‚ùå N√£o encontrei resultados espec√≠ficos para sua consulta.\n\nüîç **Tente perguntar sobre:**\n‚Ä¢ Dosagens espec√≠ficas (CBD, THC)\n‚Ä¢ Condi√ß√µes m√©dicas (epilepsia, dor, ansiedade)\n‚Ä¢ Efeitos colaterais\n‚Ä¢ Regulamenta√ß√£o ANVISA";
    }
    
    const studyResults = results.filter(r => r.type === 'study');
    const caseResults = results.filter(r => r.type === 'case');
    const alertResults = results.filter(r => r.type === 'alert');
    
    let answer = `üéØ **RESULTADOS ENCONTRADOS:**\n\n`;
    
    if (studyResults.length > 0) {
      answer += `üìö **${studyResults.length} Estudos Cient√≠ficos:**\n`;
      studyResults.slice(0, 2).forEach((result) => {
        const study = result.data as ScientificStudy;
        answer += `‚Ä¢ ${study.title}\n  ${study.compound} para ${study.indication}\n\n`;
      });
    }
    
    if (caseResults.length > 0) {
      answer += `üè• **${caseResults.length} Casos Cl√≠nicos:**\n`;
      caseResults.slice(0, 2).forEach((result) => {
        const clinicalCase = result.data as ClinicalCase;
        answer += `‚Ä¢ ${clinicalCase.caseNumber}: ${clinicalCase.indication}\n`;
      });
      answer += `\n`;
    }
    
    if (alertResults.length > 0) {
      answer += `‚ö†Ô∏è **${alertResults.length} Alertas Regulat√≥rios:**\n`;
      alertResults.slice(0, 1).forEach((result) => {
        const alert = result.data as Alert;
        answer += `‚Ä¢ ${alert.message.substring(0, 100)}...\n`;
      });
    }
    
    return answer;
  }
}